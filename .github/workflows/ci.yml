name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - name: Install dependencies
        run: pip install black==20.8b1 flake8==3.8.4
      - run: flake8 .
      - run: black --check --line-length=100 .

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - name: Install Java
        run: |
          sudo apt-get install openjdk-11-jdk
          java -version
      - name: Install plugin & test dependencies
        run: |
          pip install -e .
          pip install pytest==6.1.1
          which torchserve
          which torch-model-archiver
          which mlflow deployments create --help
      - name: Run tests
        run: pytest tests --color=yes --verbose
